// Prisma schema file
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Application metadata for system configuration
model AppMeta {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// User model for authentication
model User {
  id               String   @id @default(cuid())
  email            String   @unique
  username         String   @unique
  passwordHash     String?  // Optional for OAuth users
  refreshTokenHash String?  // Hashed refresh token for validation
  firstName        String   @default("")
  lastName         String   @default("")
  language         String   @default("en") // Preferred language (ISO 639-1 code)
  avatarUrl        String?  // URL to profile picture
  
  // OAuth fields
  oauthProvider    String?  // e.g., "42", "google"
  oauthProviderId  String?  // User ID from OAuth provider
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  passwordResetTokens PasswordResetToken[]
  comments            Comment[]

  @@unique([oauthProvider, oauthProviderId])
  @@index([email])
  @@index([username])
}

// OAuth exchange codes for secure token exchange (one-time use, short TTL)
model OAuthExchangeCode {
  id        String    @id @default(cuid())
  userId    String
  codeHash  String    @unique // Hashed for security
  expiresAt DateTime
  usedAt    DateTime? // Null if not yet used
  createdAt DateTime  @default(now())

  @@index([codeHash])
  @@index([expiresAt])
}

// Password reset tokens for forgot password flow
model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    // Hashed token for security
  expiresAt DateTime
  usedAt    DateTime? // Null if not yet used, set when consumed
  createdAt DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
}

// OMDb metadata cache for movies
model MovieMetadataCache {
  id        String   @id @default(cuid())
  cacheKey  String   @unique // normalizedTitle+year OR imdbId
  data      Json     // Cached OMDb response data
  fetchedAt DateTime @default(now())
  expiresAt DateTime

  @@index([cacheKey])
  @@index([expiresAt])
}

// Comments on movies
model Comment {
  id        String   @id @default(cuid())
  movieId   String   // Stable movie ID from /movies/:id
  userId    String
  body      String   @db.VarChar(2000)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([movieId, createdAt])
  @@index([userId, createdAt])
}
